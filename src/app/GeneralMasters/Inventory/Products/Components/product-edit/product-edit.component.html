<!-- Contenedor Principal con la fuente y fondo estandarizados -->
<div class="flex w-full h-full font-titillium">
  <!-- Tarjeta de Contenido Principal, aplicando el estilo de la guía -->
  <div class="m-4 md:m-10 w-full font-medium bg-white rounded-2xl md:rounded-3xl p-6 md:p-10">

    <!-- 1. CABECERA: Título y Botón de Regreso -->
    <div class="flex justify-between items-start mb-12">
      <!-- Título con el estilo de marca -->
      <div class="items-center">
        <h1 class="font-family-titillium font-bold text-3xl/41 text-primary border-b-4 border-secondary inline-block pb-1">
          Editar Producto
        </h1>
        <p class="font-family-sans font-normal text-sm mt-2">
          Modifique la información del producto y guarde los cambios.
        </p>
      </div>

      <!-- Botón de Regreso -->
      <div class="hidden sm:block">
        <p-button icon="pi pi-arrow-left" (click)="goBack()" pTooltip="Regresar a la lista"
          styleClass="p-button-text p-button-secondary"></p-button>
      </div>
    </div>

    <!-- 2. FORMULARIO DE EDICIÓN DE PRODUCTO -->
    <!-- Usamos @if para mostrar un spinner mientras se carga la data inicial -->
    @if (isLoading) {
      <div class="flex justify-center items-center p-8 mt-10">
        <i class="pi pi-spin pi-spinner" style="font-size: 2.5rem; color: var(--primary-color);"></i>
        <p class="ml-3 text-primary text-lg">Cargando datos del producto...</p>
      </div>
    } @else {
      <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-24 mt-24 font-family-sans">
          
          <!-- Nombre del Producto -->
          <div class="flex flex-col gap-2">
            <label for="name" class="font-semibold text-primary">Nombre del Producto</label>
            <input pInputText id="name" formControlName="name" class="w-full md:w-2/3" />
            @if (productForm.get('name')?.invalid && productForm.get('name')?.touched) {
              <small class="text-red-500">El nombre es requerido.</small>
            }
          </div>

          <!-- Referencia -->
          <div class="flex flex-col gap-2">
            <label for="reference" class="font-semibold text-primary">Referencia / SKU</label>
            <input pInputText id="reference" formControlName="reference" class="w-full md:w-2/3" />
          </div>

          <!-- Presentación -->
          <div class="flex flex-col gap-2">
            <label for="presentation" class="font-semibold text-primary">Presentación</label>
            <input pInputText id="presentation" formControlName="presentation" class="w-full md:w-2/3" />
          </div>

          <!-- Cantidad (Normalmente no se edita aquí, pero se mantiene si es un requisito) -->
          <div class="flex flex-col gap-2">
            <label for="quantity" class="font-semibold text-primary">Cantidad en Inventario</label>
            <p-inputNumber inputId="quantity" formControlName="quantity" [min]="0" styleClass="w-full md:w-2/3"></p-inputNumber>
            @if (productForm.get('quantity')?.invalid && productForm.get('quantity')?.touched) {
              <small class="text-red-500">La cantidad es requerida y no puede ser negativa.</small>
            }
          </div>

          <!-- Impuesto(s) -->
          <div class="flex flex-col gap-2">
            <label for="taxPercentage" class="font-semibold text-primary">Impuesto(s)</label>
            <p-select
              id="taxSelect"
              [options]="taxes"
              optionLabel="displayText"
              [optionValue]="'interest'"
              placeholder="Seleccione un impuesto"
              [filter]="true"
              [showClear]="shouldShowClear('taxPercentage')"
              class="w-full md:w-2/3"
              formControlName="taxPercentage"
              (onChange)="onFieldChange('taxPercentage')"
            >
              <ng-template pTemplate="selectedItem" let-selectedOption>
                <div *ngIf="selectedOption">{{ selectedOption.code }} ({{ selectedOption.interest }}%)</div>
              </ng-template>
              <ng-template pTemplate="item" let-option>
                <div>{{ option.code }} ({{ option.interest }}%)</div>
              </ng-template>
            </p-select>
            @if (productForm.get('taxPercentage')?.invalid && productForm.get('taxPercentage')?.touched) {
              <small class="text-red-500">El impuesto es requerido.</small>
            }
          </div>

          <!-- Costo -->
          <div class="flex flex-col gap-2">
            <label for="cost" class="font-semibold text-primary">Costo</label>
            <p-inputNumber inputId="cost" formControlName="cost" mode="currency" currency="COP" locale="es-CO" [min]="0" styleClass="w-full md:w-2/3"></p-inputNumber>
            @if (productForm.get('cost')?.invalid && productForm.get('cost')?.touched) {
              <small class="text-red-500">El costo es requerido y no puede ser negativo.</small>
            }
          </div>

          <!-- Tipo de Producto -->
          <div class="flex flex-col gap-2">
            <label for="productTypeId" class="font-semibold text-primary">Tipo de Producto</label>
            <p-select
              id="productTypeId"
              formControlName="productTypeId"
              [options]="productTypes"
              optionLabel="name"
              placeholder="Seleccione un tipo"
              [filter]="true"
              [showClear]="shouldShowClear('productTypeId')"
              class="w-full md:w-2/3"
              (onChange)="onFieldChange('productTypeId')"
            >
              <ng-template pTemplate="selectedItem" let-selectedOption>
                <div *ngIf="selectedOption">
                  {{ selectedOption.name }}
                </div>
              </ng-template>
              <ng-template pTemplate="item" let-option>
                <div>{{ option.name }}</div>
              </ng-template>
            </p-select>
            @if (productForm.get('productTypeId')?.invalid && productForm.get('productTypeId')?.touched) {
              <small class="text-red-500">Debe seleccionar un tipo de producto.</small>
            }
          </div>

          <!-- Unidad de Medida -->
          <div class="flex flex-col gap-2">
            <label for="unitOfMeasureId" class="font-semibold text-primary">Unidad de Medida</label>
            <p-select
              id="unitOfMeasureId"
              formControlName="unitOfMeasureId"
              [options]="unitOfMeasures"
              optionLabel="name"
              placeholder="Seleccione una unidad"
              [filter]="true"
              [showClear]="shouldShowClear('unitOfMeasureId')"
              class="w-full md:w-2/3"
              (onChange)="onFieldChange('unitOfMeasureId')"
            >
              <ng-template pTemplate="selectedItem" let-selectedOption>
                <div *ngIf="selectedOption">
                  {{ selectedOption.name }}
                </div>
              </ng-template>
              <ng-template pTemplate="item" let-option>
                <div>{{ option.name }}</div>
              </ng-template>
            </p-select>
            @if (productForm.get('unitOfMeasureId')?.invalid && productForm.get('unitOfMeasureId')?.touched) {
              <small class="text-red-500">Debe seleccionar una unidad de medida.</small>
            }
          </div>

          <!-- Categoría -->
          <div class="flex flex-col gap-2">
            <label for="categoryId" class="font-semibold text-primary">Categoría</label>
            <p-select
              id="categoryId"
              formControlName="categoryId"
              [options]="categories"
              optionLabel="name"
              placeholder="Seleccione una categoría"
              [filter]="true"
              [showClear]="shouldShowClear('categoryId')"
              class="w-full md:w-2/3"
              (onChange)="onFieldChange('categoryId')"
            >
              <ng-template pTemplate="selectedItem" let-selectedOption>
                <div *ngIf="selectedOption">
                  {{ selectedOption.name }}
                </div>
              </ng-template>
              <ng-template pTemplate="item" let-option>
                <div>{{ option.name }}</div>
              </ng-template>
            </p-select>
            @if (productForm.get('categoryId')?.invalid && productForm.get('categoryId')?.touched) {
              <small class="text-red-500">Debe seleccionar una categoría.</small>
            }
          </div>
          
          <!-- Descripción -->
          <div class="md:col-span-2 flex flex-col gap-2">
            <label for="description" class="font-semibold text-primary">Descripción</label>
            <textarea id="description" formControlName="description" placeholder="Añade aquí cualquier observación..." rows="3" pInputTextarea class="p-inputtext w-full md:w-2/3"></textarea>
            @if (productForm.get('description')?.invalid && productForm.get('description')?.touched) {
              <small class="text-red-500">La descripción es requerida.</small>
            }
          </div>
        </div>

        <!-- 3. BOTONES DE ACCIÓN -->
        <div class="flex justify-center gap-4 mt-12 pt-40">
          <p-button 
            type="button"
            label="Cancelar" 
            severity="secondary"
            (onClick)="goBack()">
          </p-button>
          <p-button 
            type="submit"
            label="Guardar Cambios"
            [disabled]="productForm.invalid || !hasChanges">
          </p-button>
        </div>
      </form>
    }
  </div>
</div>